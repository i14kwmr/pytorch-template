FROM nvidia/cuda:8.0-cudnn6-devel
MAINTAINER Yousuke123

# --- Install Packages with Apt-Get ---
RUN apt-get update -y && apt-get upgrade -y
RUN apt-get install -y \
    sudo ssh \
    build-essential \
    zsh tmux make unzip git curl wget vim tree htop \
    graphviz && \
    apt-get clean -y && \
    rm -rf /var/lib/apt/lists/*

# --- Install Pyenv & Pyenv-Virtualenv ---
RUN git clone https://github.com/yyuu/pyenv.git /opt/.pyenv && \
    git clone https://github.com/yyuu/pyenv-virtualenv.git /opt/.pyenv/plugins/pyenv-virtualenv
ENV PYENV_ROOT /opt/.pyenv
ENV PATH $PYENV_ROOT/bin:$PATH

# --- Install Anaconda3 ---
ARG ANACONDA3_VER="4.2.0"
RUN pyenv install anaconda3-$ANACONDA3_VER && \
    pyenv global anaconda3-$ANACONDA3_VER
ENV PATH $PYENV_ROOT/shims:$PATH
RUN conda update -y conda && pip install --upgrade pip
RUN pip install pudb

# --- Install Tensorflow & Keras ---
ARG TF_BINARY_URL="https://storage.googleapis.com/tensorflow/linux/gpu/tensorflow_gpu-1.4.0-cp35-cp35m-linux_x86_64.whl"
RUN pip install $TF_BINARY_URL && pip install --upgrade keras

# --- Root User Settings in Container ---
ARG ROOT_PASSWORD="password"
RUN echo "root:$ROOT_PASSWORD" | chpasswd
RUN echo '\nexport PYENV_ROOT=/opt/.pyenv \nexport PATH=$PYENV_ROOT/bin:$PATH \neval "$(pyenv init -)"' >> $HOME/.bashrc

# --- User Settings in Container ---
# NOTE: It is assumed that root user has UID=10000:GID=100 in host computer.
ARG GROUP_ID=413
ARG GROUP_NAME="Domain"
RUN groupadd -g $GROUP_ID $GROUP_NAME
# Main User Settings
ARG MAIN_USER_ID=8
ARG MAIN_USER_NAME="sayaka"
RUN useradd --create-home --shell /bin/bash -g $GROUP_NAME -u $MAIN_USER_ID $MAIN_USER_NAME && \
    echo "$MAIN_USER_NAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
ADD set_jupyter_config.py /home/$MAIN_USER_NAME
# Other Users Settings
ARG USERS_FILE="users"
ADD $USERS_FILE $USERS_FILE
RUN cat $USERS_FILE | while read line; do useradd --create-home --shell /bin/bash -g $GROUP_NAME -u $line; done && rm -f $USERS_FILE

# --- Jupyter Notebook Setting ---
EXPOSE 8888

